% fast single solution to p4p + focal problem
% by Martin Bujnak (c) 2011
%
% function [f za zb zc zd] = mbp4pf_adddepths(glab, a1, b1, c1, d1)
% 
% input:
% 	glab = vector of distances between 4 3D points in order
%       	 [AB,AB,AD,BC,BD,CD]
%
% 	a1 = [a1 a2] = 2D projection of 3D point A
% 	b1 = [b1 b2] = 2D projection of 3D point B
% 	c1 = [c1 c2] = 2D projection of 3D point C
% 	d1 = [d1 d2] = 2D projection of 3D point D
%
% output:
%
% 	f - focal length
%	za - depth of point A in camera coordinate system
%	zb - depth of point B in camera coordinate system
%	zc - depth of point C in camera coordinate system
%	zd - depth of point D in camera coordinate system

function [f za zb zc zd meta M] = mbp4pfss7678za(glab, a1, b1, c1, d1)

	% instance=gbs_RandomInstanceZp ordering={za,f,zb,zc,zd} equations={1,2,3,4,5} basis={1,za,za*zd,f,f*zc,f*zd,zb,zb*zd,zc,zc*zd,zd,zd^2} 
	% gj = 1 subst = 1
	meta = {1,0, {'gbs_RandomInstanceZp'}, {'f' 'za' 'zb' 'zc' 'zd'}, {1,2,3,4,5}, {'1' 'za'} };


	M = zeros(76, 78);
	M([53, 128, 279, 506, 657, 1036, 1379, 1454, 1605, 1832, 1983, 2362]) = 1;
	M([585, 736, 887, 1114, 1265, 1911, 2062, 2213, 2440, 2591, 2818]) = -2;
	M([1193, 1344, 2519, 2670, 2745, 2896, 2971]) = 1;
	M([1421, 1496, 1647, 1874, 2025, 2404, 3051, 3126, 3277, 3504, 3655, 4034]) = b1(2)^2+b1(1)^2;
	M([1953, 2104, 2255, 2482, 2633, 2860, 3583, 3734, 3885, 4112, 4263]) = -2*b1(2)*a1(2)-2*b1(1)*a1(1);
	M([2561, 2712, 2787, 2938, 3013, 4191, 4342, 4417]) = a1(2)^2+a1(1)^2;
	M([4613, 4764, 4839, 4990, 5179, 5330, 5405, 5556, 5631, 5706]) = -glab(1);
	M([61, 136, 211, 362, 513, 588, 739, 1118, 1387, 1462, 1537, 1688, 1839, 1914, 2065, 2444, 4485]) = 1;
	M([517, 668, 743, 894, 1045, 1120, 1271, 1843, 1994, 2069, 2220, 2371, 2446, 2597, 2824, 4865]) = -1;
	M([593, 744, 819, 970, 1121, 1196, 1347, 1919, 2070, 2145, 2296, 2447, 2522, 2673, 2900, 4941]) = -1;
	M([1125, 1276, 1351, 2451, 2602, 2677, 2752, 2827, 2902, 2977]) = 1;
	M([1429, 1504, 1579, 1730, 1881, 1956, 2107, 2486, 3059, 3134, 3209, 3360, 3511, 3586, 3737, 4116, 5093]) = b1(1)*c1(1)+c1(2)*b1(2);
	M([1885, 2036, 2111, 2262, 2413, 2488, 2639, 2866, 3515, 3666, 3741, 3892, 4043, 4118, 4269, 5473]) = -b1(2)*a1(2)-b1(1)*a1(1);
	M([1961, 2112, 2187, 2338, 2489, 2564, 2715, 2942, 3591, 3742, 3817, 3968, 4119, 4194, 4345, 5549]) = -c1(2)*a1(2)-c1(1)*a1(1);
	M([2493, 2644, 2719, 2794, 2869, 2944, 3019, 4123, 4274, 4349, 4424, 5701]) = a1(2)^2+a1(1)^2;
	M([4545, 4696, 4771, 4846, 4921, 4996, 5111, 5262, 5337, 5412, 5487, 5562, 5637, 5712, 5853]) = 1/2*glab(4)-1/2*glab(1)-1/2*glab(2);
	M([218, 445, 596, 823, 1202, 1393, 1544, 1771, 1922, 2149, 2528, 4562]) = 1;
	M([750, 977, 1128, 1355, 1849, 2076, 2303, 2454, 2681, 2908, 4942]) = -2;
	M([1282, 2381, 2608, 2759, 2834, 2985]) = 1;
	M([1586, 1813, 1964, 2191, 2570, 3065, 3216, 3443, 3594, 3821, 4200, 5170]) = c1(2)^2+c1(1)^2;
	M([2118, 2345, 2496, 2723, 2950, 3521, 3748, 3975, 4126, 4353, 5550]) = -2*c1(1)*a1(1)-2*c1(2)*a1(2);
	M([2650, 2801, 2876, 3027, 4053, 4280, 4431, 5702]) = a1(1)^2+a1(2)^2;
	M([4702, 4853, 4928, 5041, 5268, 5419, 5494, 5645, 5720, 5854]) = -glab(2);
	M([300, 375, 678, 753, 904, 1283, 1477, 1552, 1627, 1702, 2005, 2080, 2231, 2610, 4639]) = 1;
	M([680, 755, 1058, 1133, 1284, 1857, 1932, 2007, 2082, 2385, 2460, 2611, 2838, 4867]) = -1;
	M([908, 983, 1286, 1361, 2085, 2160, 2235, 2310, 2613, 2688, 2763, 2990]) = -1;
	M([1288, 1363, 2465, 2540, 2615, 2690, 2841, 2916, 2991]) = 1;
	M([1668, 1743, 2046, 2121, 2272, 2651, 3149, 3224, 3299, 3374, 3677, 3752, 3903, 4282, 5247]) = b1(2)*d1(2)+b1(1)*d1(1);
	M([2048, 2123, 2426, 2501, 2652, 2879, 3529, 3604, 3679, 3754, 4057, 4132, 4283, 5475]) = -b1(1)*a1(1)-b1(2)*a1(2);
	M([2276, 2351, 2654, 2729, 2804, 3031, 3757, 3832, 3907, 3982, 4285, 4360, 4435, 5627]) = -a1(2)*d1(2)-a1(1)*d1(1);
	M([2656, 2731, 2882, 2957, 3032, 4137, 4212, 4287, 4362, 5703]) = a1(1)^2+a1(2)^2;
	M([4708, 4783, 4934, 5009, 5125, 5200, 5275, 5350, 5501, 5576, 5651, 5726, 5855]) = 1/2*glab(5)-1/2*glab(3)-1/2*glab(1);
	M([456, 835, 986, 1365, 1485, 1560, 1711, 1786, 2089, 2164, 2315, 2694, 4716]) = 1;
	M([836, 1215, 1366, 1865, 1940, 2091, 2166, 2469, 2544, 2695, 2922, 4944]) = -1;
	M([988, 1367, 2017, 2092, 2243, 2318, 2621, 2696, 2771, 2998]) = -1;
	M([1368, 2397, 2472, 2623, 2698, 2849, 2924, 2999]) = 1;
	M([1824, 2203, 2354, 2733, 3157, 3232, 3383, 3458, 3761, 3836, 3987, 4366, 5324]) = c1(1)*d1(1)+c1(2)*d1(2);
	M([2204, 2583, 2734, 2961, 3537, 3612, 3763, 3838, 4141, 4216, 4367, 5552]) = -c1(2)*a1(2)-c1(1)*a1(1);
	M([2356, 2735, 2810, 3037, 3689, 3764, 3915, 3990, 4293, 4368, 4443, 5628]) = -a1(2)*d1(2)-a1(1)*d1(1);
	M([2736, 2963, 3038, 4069, 4144, 4295, 4370, 5704]) = a1(1)^2+a1(2)^2;
	M([4788, 5015, 5057, 5132, 5283, 5358, 5509, 5584, 5659, 5734, 5856]) = -1/2*glab(3)-1/2*glab(2)+1/2*glab(6);
	M([1643, 1718, 1793, 2248, 2323, 2778, 4793]) = 1;
	M([2023, 2098, 2173, 2628, 2703, 3006]) = -2;
	M([2403, 2478, 2553, 2856, 2931]) = 1;
	M([3315, 3390, 3465, 3920, 3995, 4450, 5401]) = d1(1)^2+d1(2)^2;
	M([3695, 3770, 3845, 4300, 4375, 5629]) = -2*a1(2)*d1(2)-2*a1(1)*d1(1);
	M([4075, 4150, 4225, 5705]) = a1(1)^2+a1(2)^2;
	M([5063, 5138, 5213, 5516, 5591, 5742, 5857]) = -glab(3);

    reduced = gj(M, 1e-10);
    
    if (reduced(76,78) > 0)

        f = 0;
        za = 0;
        zb = 0;
        zc = 0;
        zd = 0;
        return;
    end
    
	za = sqrt(-reduced(76,78));
	zd = -(reduced(75,78))/za;
	zc = -(reduced(74,78))/za;
	zb = -(reduced(73,78))/za;
    
    %{
    Minv = inv(M(:,1:76));
	za = sqrt(-Minv(76,:)*M(:,78));
	zd = -(Minv(75,:)*M(:,78))/za;
	zc = -(Minv(74,:)*M(:,78))/za;
	zb = -(Minv(73,:)*M(:,78))/za;
    %}

    f = sqrt(-(zb^2*b1(2)^2+b1(1)^2*zb^2-2*za*zb*b1(2)*a1(2)-2*za*zb*b1(1)*a1(1)+a1(2)^2*za^2+a1(1)^2*za^2-glab(1)) / (zb^2-2*za*zb+za^2));
end
